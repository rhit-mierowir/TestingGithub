name: documentation
run-name: ${{ github.actor }} is trying to build documentation.

on: [push, pull_request, workflow_dispatch]

env:
  
  MAIN_BRANCH: 'main' # Have this specified in some other file.
  SECONDARY_BRANCH: 'develop' # Have this specified in some other file.
  TEMP_WEBSITE_FOLDER: '.website'
  SECONDARY_SITE_DIRECTORY: 'dev'

  BRANCH_NAME: ${{ github.head_ref || github.ref_name}}
  IS_MAIN_SITE_BRANCH: ${{ github.env.BRANCH_NAME == github.env.MAIN_BRANCH}}
  IS_SECONDARY_SITE_BRANCH: ${{github.env.BRANCH_NAME == github.env.SECONDARY_BRANCH}}
  MUST_REGENERATE_SITE: ${{github.env.IS_MAIN_SITE_BRANCH || github.env.IS_SECONDARY_SITE_BRANCH}}

permissions:
  contents: write

jobs:
  docs:
    runs-on: ubuntu-latest
    if: ${{github.event_name == 'push' && (github.env.BRANCH_NAME == github.env.MAIN_BRANCH || github.env.BRANCH_NAME == github.env.SECONDARY_BRANCH)}}

    steps:
      
      - name: Setup python
        uses: actions/setup-python@v5

      - name: Setup Directory Structure
        run: |
          pwd
          mkdir $MAIN_BRANCH
          mkdir $SECONDARY_BRANCH
          mkdir $TEMP_WEBSITE_FOLDER
      - name: Test thing
        run: |
          pwd
          ls -a
          

      - name: Checkout Main Branch
        uses: actions/checkout@v4
        with:
          ref: ${{github.env.MAIN_BRANCH}}
          path: ./${{github.env.MAIN_BRANCH}}
    
      - name: Checkout Secondary Branch
        uses: actions/checkout@v4
        with:
          ref: ${{github.env.SECONDARY_BRANCH}}
          path: ./${{github.env.SECONDARY_BRANCH}}
      

      - name: Install General dependencies
        run: |
          pwd
          ls -a
          pip install poetry

      - name: 'MAIN SITE: Install dependencies with Sphinx'
        run: |
          ls -a
          pwd
          cd $MAIN_BRANCH
          poetry install --with gh_docs --no-root

      - name: 'MAIN SITE: Sphinx build'
        run: |
          poetry run sphinx-build docs/sphinx/source ../$TEMP_WEBSITE_FOLDER
          cd ..

      - name: 'SECONDARY SITE: Install dependencies with Sphinx'
        run: |
          ls -a
          cd $SECONDARY_BRANCH
          poetry install --with gh_docs --no-root
  
      - name: 'SECONDARY SITE: Sphinx build'
        run: |
          poetry run sphinx-build docs/sphinx/source ../$TEMP_WEBSITE_FOLDER }}/$SECONDARY_SITE_DIRECTORY
          cd ..

      - name: Deploy Combined Website to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          publish_branch: gh-pages
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ${{ github.env.TEMP_WEBSITE_FOLDER }}
          force_orphan: true